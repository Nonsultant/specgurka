@page "/product/{productName}/{id:guid}/{featureId:guid?}/{rule?}"
@model VizGurka.Pages.Product.ProductModel
@{
    Layout = "~/Pages/Shared/_ProductLayout.cshtml";
}
<section class="product_section">
    <section>
        <div class="sidemenu">
            <h1 class="sidemenu_title">@Model.ProductName</h1>
            <p style="background-color: rgb(219, 219, 219); margin: 0;">!Make this menu sticky with scrolling overflow
                instead!</p>
            <h3 class="sidemenu_date">Generated: @Model.LatestRunDate.ToString("dd MMMM yyyy HH:mm")</h3>

            @if (Model.Features != null && Model.Features.Any())
            {
                @for (int i = 0; i < Model.Features.Count; i++)
                {
                    var feature = Model.Features[i];
                    var featureId = Model.FeatureIds[i];
                    <div class="feature-dropdown">
                        <i class="arrow right arrow-trigger"></i>
                        <img class="status_img" src="~/icons/@(IconHelper.GetStatusIcon(feature.Status)).svg"
                            alt="status icon" />
                        <a class="feature_sidebar" asp-page="/product/product" asp-route-productName="@Model.ProductName"
                            asp-route-id="@Model.Id" asp-route-featureId="@featureId">@feature.Name</a>
                    </div>
                    <div class="dropdown-content">
                        <ul>
                            @foreach (var scenario in feature.Scenarios)
                            {
                                <li class="scenario_link">
                                    <img src="~/icons/@(IconHelper.GetStatusIcon(scenario.Status)).svg" alt="status icon" />
                                    <p>@scenario.Name</p>
                                </li>
                            }
                            @foreach (var rule in feature.Rules)
                            {
                                <li>
                                    <h3 class="rule_sidebar">
                                        @{
                                            var decodedRuleName = System.Net.WebUtility.UrlDecode(rule.Name);
                                        }
                                        <img src="~/icons/@(IconHelper.GetStatusIcon(rule.Status)).svg" alt="status icon" />
                                        <a
                                            href="@Html.Raw($"/product/{Model.ProductName}/{Model.Id}/{featureId}/#{decodedRuleName}")">
                                            @rule.Name
                                        </a>
                                    </h3>
                                    <ul>
                                        @foreach (var scenario in rule.Scenarios)
                                        {
                                            <li class="scenario_link">
                                                <img src="~/icons/@(IconHelper.GetStatusIcon(scenario.Status)).svg" alt="status icon" />
                                                <p>@scenario.Name</p>
                                            </li>
                                        }
                                    </ul>
                                </li>
                            }
                        </ul>
                    </div>
                }
            }
            else
            {
                <p>No features available.</p>
            }
        </div>
    </section>

    <section class="content_section">
        <div class="content_container">
            @if (Model.SelectedFeature != null)
            {
                <div class="content_container_header">
                    <h1 class="content_container_title">
                        <img class="container_title_status_img"
                            src="~/icons/@(IconHelper.GetStatusIcon(@Model.SelectedFeature.Status)).svg"
                            alt="status icon" />
                        @Model.SelectedFeature.Name
                    </h1>
                    <p class="content_container_duration">Test Duration: @Model.SelectedFeature.TestDuration</p>
                </div>
                <h2 class="container_scenarios_title">Scenarios</h2>
                <ul class="scenario_list">
                    @foreach (var scenario in Model.SelectedFeature.Scenarios)
                    {
                        <hr />
                        <h2 class="container_scenario_name">
                            <img class="container_scenario_status_img"
                                src="~/icons/@(IconHelper.GetStatusIcon(scenario.Status)).svg" alt="status icon" />
                            @scenario.Name
                        </h2>
                        <h3 class="container_scenario_duration"><strong>Scenario duration:</strong> @scenario.TestDuration</h3>
                        @foreach (var step in scenario.Steps)
                        {
                            <div class="container_scenario_step">
                                <img class="container_scenario_status_img"
                                    src="~/icons/@(IconHelper.GetStatusIcon(step.Status)).svg" alt="status icon" />
                                <strong>@step.Kind</strong> @step.Text
                            </div>
                        }
                    }
                </ul>

                @if (Model.SelectedFeature.Rules.Any())
                {
                    @foreach (var rule in Model.SelectedFeature.Rules)
                    {
                        <div class="container_scenario_rule">
                            <hr />
                            <h3 class="scenario_rule_name" id="@rule.Name">Rule: @rule.Name</h3>
                            <div class="scenario_rule_description" id="scenario_rule_description">
                                @Model.MarkdownStringToHtml(rule.Description)</div>
                        </div>
                        <ul class="scenario_list">
                            @foreach (var scenario in rule.Scenarios)
                            {
                                <hr />
                                <h2 class="container_scenario_name">
                                    <img class="container_scenario_status_img"
                                        src="~/icons/@(IconHelper.GetStatusIcon(scenario.Status)).svg" alt="status icon" />
                                    @scenario.Name
                                </h2>
                                <h3 class="container_scenario_duration"><strong>Scenario duration:</strong> @scenario.TestDuration</h3>
                                @foreach (var step in scenario.Steps)
                                {
                                    <div class="container_scenario_step">
                                        <img class="container_scenario_status_img"
                                            src="~/icons/@(IconHelper.GetStatusIcon(step.Status)).svg" alt="status icon" />
                                        <strong>@step.Kind</strong> @step.Text
                                    </div>
                                }
                            }
                        </ul>
                    }
                }
            }
            else
            {
                <p>No feature selected.</p>
            }
        </div>
    </section>
</section>

<script src="~/js/dropdown.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const ruleName = urlParams.get('rule');
        const featureId = urlParams.get('featureId');
        if (ruleName && featureId) {
            const targetId = `${featureId}-${ruleName}`;
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: "smooth" });
            }
        }
    });
</script>